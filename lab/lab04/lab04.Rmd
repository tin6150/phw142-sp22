---
title: 'Lab 4: Screening and Precision Public Health'
author: "Tin Ho 3033518349"
date: "2022-02-21"
output: pdf_document
---


**Run this chunk of code to load the autograder package!**
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(testthat)
```

### Instructions 
* Due date: Monday, February 21nd at 11:59pm.
* Late penalty: 50% late penalty if submitted within 24 hours of due date, no marks for assignments submitted thereafter.
* This assignment is graded on **correct completion**, all or nothing. You must pass all public tests and submit the assignment for credit.
* Submission process: Follow the submission instructions on the final page. Make sure you do not remove any `\newpage` tags or rename this file, as this will break the submission.

# Screening
We will talk about a very important use of conditional probability in public health and medicine, which is the idea of tools that screen for health outcomes. There are many examples of this, including mammograms for detection of breast cancer, the prostate specific antigen (PSA) for detection of prostate cancer, as well as tests for exposure to infectious diseases, and so forth. We will consider two types of events: i) whether the subject truly has the health condition of interest (let $D$ denote the disease of interest, and $D'$ its complement), and ii) whether a test was positive or not for this outcome (let $+$ denote a positive test and $-$ denote its complement, a negative test). There are several statistics that are used to evaluate the performance of a test, some of which are derivable from each other:

- Sensitivity: $P(+ \mid D)$ or the probability of test being positive if one has the disease.
- Specificity: $P(- \mid D')$ or the probability of test being negative given one does not have the disease. 
- Positive predictive value (PPV): $P(D \mid +)$ or the probability of having the disease if an individual tests positive.
- Negative predictive value (NPV):  $P(D' \mid -)$ or the probability of not having the disease if an individual tests negative.

Consider the following situation: Assume the total number of subjects is 10,000 and that $P(D) = 0.05$, $P(+ \mid D) = 0.95$, $P(- \mid D') = 0.95$. This set up implies that the disease is rare, but a very accurate test exists for the disease (i.e., equally high sensitivity and specificity).

P(D) = 0.05
P(+|D) = 0.95   this is subbranch .  for 0.95 of 0.05!     or .95*500 = 475
P(-|D')= 0.95      .95*9500 = 9025

**1. [1 point] Fill in the following two-way table with the absolute frequencies provided in the problem. (You can fill it in simply by typing the frequencies in the nine empty cells.):**

|       | $D$ | $D'$ |  Total|
|-------|-----|------|-------|
|+      |  475|  475 |    950|
|-      |   25| 9025 |  9,050|
| Total |  500| 9500 | 10,000|

```{r}
10000*.05
```
Create a vector called `p1` with the entries of this table, entering one column at a time.  For example, if my table was as follows:

|       | $D$ | $D'$ |  Total|
|-------|-----|------|-------|
|+      |  1  |  2   |  3    |
|-      |  4  |  5   |  6    |
| Total |  7  |  8   |  9    |

Then I would enter my vector as:
```{r}
p1 <- c(1, 4, 7, 2, 5, 8, 3, 6, 9)
```

```{r}
p1 <- NULL # YOUR CODE HERE
p1
# vector are column first!  
p1 = c(475,25,500, 475,9025,9500, 950,9050,10000)
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p1.R")
```

\newpage

**2. [1 point] Calculate the PPV (Positive Predictive Value) using the entries from your table. Store the PPV as a percentage assigned to `p2`.**

```{r}
p2 <- NULL # YOUR CODE HERE
p2 = 475/950*100
### PPV = P(D+|T+) = 475/950  --> 50%

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p2.R")
```

\newpage
  
**3. [1 point] Re-do the two-way table and re-calculate the PPV, this time assuming that $P(D)=0.02$. (Note that $P(+ \mid D) = 0.95$, $P(- \mid D') = 0.95$, as with the previous question). Similarly, create a vector, `p3`, with the entries of this table, entering one column at a time.**


$P(D)=0.02$. 
$P(+ \mid D) = 0.95$, 
$P(- \mid D') = 0.95$, 

|       | $D$ | $D'$ |  Total|
|-------|-----|------|-------|
|+      |  190|  490 |    680|
|-      |   10| 9310 |   9320|
| Total |  200| 9800 |  10000|

```{r}
.02*10000
.95*200
.95*9800
p3 <- NULL # YOUR CODE HERE
p3 = c(190,10,200,  490,9310,9800,   680,9320,10000)

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p3.R")
```
 
\newpage 
    
**4. [1 point] Again, calculate the PPV (Positive predictive value) using the entries from your table. Store the PPV as a percentage rounded to 1 decimal place.**

```{r}
p4 <- NULL # YOUR CODE HERE
p4 = round(190/680*100, digits=1)
### PPV = P(D+|T+) = 190/680  --> 27.94%
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p4.R")
```

\newpage

**5. Explain why the first scenario has a high sensitivity and a low PPV, and why the second scenario has an even lower PPV.**

_The Disease Prevalence in the first case was higher than the 2nd case.  PPV is sensitive to Prevalence, thus the 2nd scenario PPV became lower_

\newpage
  
## Precision in public health

One of the goals of public health research is to group people by risk factors or demographic variables so that decision-makers can predict, with actionable accuracy, which groups are at high and low risk of an adverse health outcome. In this set of questions, we consider stratified two-way tables, which are two-way tables specific to levels of a third grouping variable. Here, the adverse health outcome is coronary heart disease (CHD), which we represent by $D$. We study two categorical risk factors, smoking (defined by $S$ for smoking and $S'$ for no smoking) and age (defined by $A$ for older age and $A'$ for younger age). 

First, read in the aggregated data set. The last column (n) is the number of individuals in each group. 
                       
```{r makepop, message=F,warning=F}
library(dplyr)
library(tidyverse)
chd_dat <- read_csv("data/CHD.csv")
chd_dat
#View(chd_dat)

chd_dat %>% filter(Age=='young') %>% group_by(CHD) %>% summarize(suma=sum(n))

chd_dat %>% summarize(sum(n))
```
                       
**6. [1 point] Using the table above, calculate the following probabilities. Convert your answers to percentages and round to the nearest whole number. Store the values (without the "%" and in the specified order below) in the vector `p6`.**
                       
(the "given" is the denominator)
- $P(D \mid A', S)$     D: CHD=y D,A',S:  (60)/300 = 20  # denominator is Young and Smoke, regardless of D status, so 60+240, 
- $P(D \mid A', S')$    D        D,A',S':  105/700 = 15
- $P(D \mid A, S)$               D,A, S :  180/300 = 60
- $P(D \mid A, S')$              D,A, S':  210/700 = 30   




```{r}

# lab04 video ~[17:00]

p6 <- NULL # YOUR CODE HERE
#p6 = c(3,5,9,11)
p6 = c(20,15,60,30)

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p6.R")
```

If you prefer, you can do these calculations by hand. Some students might wish to use R commands to calculate these probabilities. There are **many** ways to do this. You could use `dplyr` functions to perform the calculations. Alternatively, here are some new functions for those of you interested in learning more R. (Note that these new functions won't be tested, they are for your information only, and to expose you to more of the R language!). 

You could consider using the `uncount()` function to expand the data based upon the numbers in each group (i.e., `n`) and assign the expanded data frame to a new name. Then, you can use the `tabyl` function from the `janitor` package to create stratified two-way tables, and the relevant `adorn_` functions from `janitor` to convert the frequencies to percentages.

```{r}

# lab04 video ~[19:00]
# Try using uncount() and tabyl() here!
chd_dat_exp = chd_dat %>% uncount(n)     # n is the col for number of individual  uncount()expands to individual row, end up with long table!
#chd_dat_exp
chd_dat_exp %>% janitor::tabyl(Smoking,CHD,Age)
# okay, this created segregated table, by Age.  But Smoking no/yes is in rows?  the cols are CHD y/n?????  not clear from output!

chd_dat_exp %>% janitor::tabyl(Smoking, CHD, Age) %>%
  janitor::adorn_percentages("row") %>%
  janitor::adorn_pct_formatting(digits=2) %>% 
  janitor::adorn_ns()    # give n values in parenthesis


# YOUR CODE HERE
```
_nice to have R do this, but output of janitor::tabl can open to lot of questions, the trade off of compactness may not be worth it_



Expected:
- $P(D \mid A', S)$     D: CHD=y D,A',S:  (60)/300 = 20  # denominator is Young and Smoke, regardless of D status, so 60+240, 
- $P(D \mid A', S')$    D        D,A',S':  105/700 = 15
- $P(D \mid A, S)$               D,A, S :  180/300 = 60
- $P(D \mid A, S')$              D,A, S':  210/700 = 30   

output from above, with my annotation:

chd_dat_exp %>% 
  tabyl(Smoking, CHD,  Age) %>%
        ^^rows   ^col  ^stratified tables
        
$old          #  CHD=         CHD=
 Smoking           no          yes
  +->  no 70.00% (490) 30.00% (210) <-- cell b: smoke=no,CHD=yes (age=old)
  \-> yes 40.00% (120) 60.00% (180)
          ^^^^^^^^^^^^
          cell c is smoke=ye
                    CHD=no


$young
 Smoking           no          yes
      no 85.00% (595) 15.00% (105) <-- smoke=no, CHD=yes, age=young
     yes 80.00% (240) 20.00%  (60)
     


 
\newpage

**7. What do these numbers imply about smoking and the risk of CHD?**
 
_smoking induce CHD, whehther young or old._


\newpage

**8. [1 point] Calculate the marginal probability of CHD. This can be written as $P(D)$. Store your answer in the object `p8` as a percent rounded to the nearest whole number.**

```{r}
p8 <- NULL # YOUR CODE HERE
p8 = round((210+180+105+60)/2000*100,digits=0)

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p8.R")
```

\newpage

**9. [1 point] Calculate the conditional probabilities ($P(D | A')$ and $P(D | A)$). Store these in the vector `p9` as percentages rounded to the nearest whole number.**

```{r}
#p9 <- NULL # YOUR CODE HERE
#p9
# chd_dat %>% filter(Age=='young') %>% group_by(CHD) %>% summarize(suma=sum(n))
#PD_na = chd_dat %>% filter(Age=='young',Smoking=="yes") %>% mutate(Prob=(n/sum(n)*100)) %>%filter(CHD=="yes") %>% dplyr::select(Prob)
#PD_na = chd_dat %>% filter(Age=='young') %>% mutate(Prob=(n/sum(n)*100)) %>%filter(CHD=="yes") %>% dplyr::select(Prob)


#PD_na = chd_dat %>% filter(Age=='young') %>% mutate(Prob=(n/sum(n)*100)) %>%filter(CHD=="yes") %>% summarize(tot=sum(Prob)) %>% dplyr::select(tot) 
#round(PD_na,2)


#?? PD_na = chd_dat %>% filter(Age=='young') %>% mutate(Prob=round(n/sum(n)*100),3) %>%filter(CHD=="yes") %>% summarize(tot=sum(Prob)) %>% dplyr::select(tot)
PD_na = chd_dat %>% filter(Age=='young') %>% mutate(Prob=(ceiling(n/sum(n)*100))) %>% filter(CHD=="yes") %>% summarize(tot=sum(Prob)) %>% dplyr::select(tot)

PD_na
                                                                 
PD_a = chd_dat %>% filter(Age=='old') %>% mutate(Prob=round((n/sum(n)*100)),0) %>%filter(CHD=="yes") %>% summarize(tot=sum(Prob)) %>% dplyr::select(tot)
PD_a

#p9=c(PD_na,PD_a)

p9=c(round(PD_na$tot,0),PD_a$tot)
p9


round(16.50,0)
round(16.51,0)

### why is 16.50 rounded to 16 and only 16.51 is rounded up to 17??
### pfff... use ceiling for this submission!


## lab04 code
chd_dat_exp %>% janitor::tabyl(Age, CHD) %>%
  janitor::adorn_percentages("row") %>%
  janitor::adorn_pct_formatting(digits=2) %>% 
  janitor::adorn_ns()    # give n values in parenthesis

#p9 = c(17,39)
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p9.R")
```

\newpage

**10. If you had an intervention that could eliminate smoking on the risk of CHD, which age group (old or young) would see the biggest change in CHD incidence?**

_The old folks, as they are the group with highest CHD rate_

\newpage

### Submission

For assignments in this class, you'll be submitting using the **Terminal** tab in the pane below. In order for the submission to work properly, make sure that:

1. Any image files you add that are needed to knit the file are in the `src` folder and file paths are specified accordingly.
2. You **have not changed the file name** of the assignment.
3. The file knits properly.

Once you have checked these items, you can proceed to submit your assignment.

1. Click on the **Terminal** tab in the pane below.
2. Copy-paste the following line of code into the terminal and press enter.

cd; cd phw142-sp22/lab/lab04; python3 turn_in.py

3. Follow the prompts to enter your Gradescope username and password.
4. If the submission is successful, you should see "Submission successful!" appear as the output. **Check your submission on the Gradescope website to ensure that the autograder worked properly and you received credit for your correct answers. If you think the autograder is incorrectly grading your work, please post on piazza!**
5. If the submission fails, try to diagnose the issue using the error messages--if you have problems, post on Piazza under the post "Datahub Issues".

The late policy will be strictly enforced, **no matter the reason**, including submission issues, so be sure to submit early enough to have time to diagnose issues if problems arise.
