---
title: "Assignment 3: Predicting insurance charges by age and BMI"
author: "Your name and student ID"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---


**Run this chunk of code to load the autograder package!**
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(testthat)
```

### Instructions 
* Solutions will be released Tuesday, February 8th.
* This semester, homework assignments are for practice only and will not be turned in for marks.

Helpful hints:

- Every function you need to use was taught during lecture! So you may need to revisit the lecture code to help you along by opening the relevant files on Datahub. Alternatively, you may wish to view the code in the condensed PDFs posted on the course website. Good luck!

- Knit your file early and often to minimize knitting errors! If you copy and paste code for the slides, you are bound to get an error that is hard to diagnose. Typing out the code is the way to smooth knitting! We recommend knitting your file each time after you write a few sentences/add a new code chunk, so you can detect the source of knitting errors more easily. This will save you and the GSIs from frustration! **You must knit correctly before submitting.**

- It is good practice to not allow your code to run off the page. To avoid this, have a look at your knitted PDF and ensure all the code fits in the file. If it doesn't look right, go back to your .Rmd file and add spaces (new lines) using the return or enter key so that the code runs onto the next line.

\newpage

--------------------------------------------------------------------------------

```{r load-libraries, message=F}
library(readr)
library(dplyr)
library(ggplot2)
library(broom)
library(forcats)
```

### Predicting insurance charges by age and BMI 

**Problem**: Medical insurance charges can vary according to the complexity of a 
procedure or condition that requires medical treatment. You are tasked with 
determining how these charges are associated with age, for patients who have a 
body mass index (bmi) in the "normal" range (bmi between 16 and 25) who are 
smokers.

**Plan**: You have chosen to use tools to examine relationships between two 
variables to address the problem. In particular, scatter plots and simple linear
regression.

**Data**: You have access to the dataset `insurance.csv`, a claims dataset from
an insurance provider.

**Analysis and Conclusion**: In this assignment you will perform the analysis 
and make a conclusion to help answer the problem statement.

\newpage

**1. [1 point] Type one line of code to import these data into R. Assign the data to `insure_data`. Execute the code by hitting the green arrow and ensure the dataset has been saved by looking at the environment tab and viewing the data set by clicking the table icon to the right of its name.**

```{r}
insure_data <- NULL 
insure_data 

insure_data = read.csv("data/insurance.csv", header=T)
insure_data %>% str
#insure_data
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p1.R")
```

\newpage

**Execute the functions below one line at a time to get to know your dataset.**

```{r initial-looks}
dim(insure_data)
names(insure_data)
str(insure_data)
head(insure_data)
```

\newpage

**2. [1 point] How many individuals are in the dataset? Assign this number to p2.**

```{r}
p2 <- NULL
#p2 = sum(insure_data)
#p2 = proportions(insure_data)
p2 = dim(insure_data)[1]

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p2.R")
```

**3. [1 point] What are the nominal variables in the dataset? Assign the names of these variables to a vector of strings, `p3`.**

```{r}
p3 <- NULL
p3 = c("smoker", "sex", "region")

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p3.R")
```

**4. [1 point] How many ordinal variables are in the dataset? Assign the *number* of ordinal variables to `p4`.**

```{r}
p4 <- NULL
p4 = 0

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p4.R")
```

**5. [1 point] Are there continuous variables in the dataset? Assign the names of these variables to a vector of strings, `p5`.**

```{r p5}
p5 <- NULL
#XX?? p5 = c("bmi","charges","children")
p5 = c("bmi","charges")

### they didn't do -ve test for things that should not be in the list?!
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p5.R")
```

**6. [1 point] What are the discrete variables in the dataset? Assign the names of these variables to a vector of strings, `p6`.**

```{r p6}
p6 <- NULL 
p6 = c("sex","smoker","region","children")

### A discrete variable is a kind of statistics variable that can only take on discrete specific values. The variable is not continuous
### then children should not have ben in the continuous 

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p6.R")
```

\newpage

**Run the following code. Remind yourself what the `mutate()` function does in general, and notice that a new function called `case_when()` is also being used.**

```{r mutate-case-when}
insure_data <- insure_data %>%
  mutate(bmi_cat = case_when(bmi < 16 ~ "Underweight",
                             bmi >= 16 & bmi < 25 ~ "Normal",
                             bmi >= 25 & bmi < 30 ~ "Overweight",
                             bmi >= 30 ~ "Obese")
                  )
```

**7. What did the code above accomplish?**

_Type your answer here, replacing this text._
added a column called bmi_cat that is categorial var for the BMI groups

\newpage

**8. [1 point] What type of variable is `bmi_cat`? Uncomment one of the choices below.**

```{r p8}
p8 <- 'ordinal'
# p8 <- 'nominal'
# p8 <- 'continuous'
# p8 <- 'discrete'

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p8.R")
```

\newpage

**9. [1 point] Read the problem statement proposed at the beginning of this exercise. Who belongs to the population of interest? Uncomment one of the choices below.** 

```{r p9}
p9 <- 'Smokers of normal BMI'
# p9 <- 'Smokers of overweight BMI'
# p9 <- 'Smokers who have abnormal BMI'
# p9 <- 'All people at risk of high medical charges'

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p9.R")
```

**10. [1 point] Using a `dplyr` function, make a new dataset called `insure_subset` containing the population of interest.**

```{r p10}
insure_subset <- NULL 
insure_subset = insure_data %>% filter(smoker=="yes",bmi_cat=="Normal")
insure_subset %>% dim
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p10.R")
```

\newpage

**11. [3 points] Make a scatter plot of the relationship between `age` and insurance `charges` for the population of interest. Give your plot an informative title.**

```{r scatter-plot}
p11 <- NULL
p11 = ggplot(insure_subset, aes(x=age,y=charges)) + geom_point() +
  labs(title="age vs insurance charges for smoker with normal bmi")
p11

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p11.R")
```

\newpage

**12. [2 points] Run a linear regression model on the relationship between `age` and `charges`. Think about which variable is explanatory (X) and which is response (Y). Assign the regression model to the object `insure_mod` and uncomment the line of code below the model to tidy the output.**

```{r regression-mod}
insure_model <- NULL
#insure_model = lm(age ~ charges, data=insure_subset)   ### WRONG !:w
insure_model = lm(charges ~ age, data=insure_subset)    
### lm( y ~ x )  ... want to predict charges, using age as input.  

tidy(insure_model)
#insure_model  %>% str
# YOUR CODE HERE
insure_model  

```

```{r}
. = ottr::check("tests/p12.R")
```

**13. [1 point] Interpret the slope parameter in the context of this problem.**

_Type your answer here, replacing this text._
slope (m) is 246.1
so, each each age increase by 1, charge will go up by 246.1



**14. [1 point] Interpret the intercept parameter.**

_Type your answer here, replacing this text._
at age 0, the chages would be 10656.1


**15. [1 point] Does the intercept make sense in this context?**

_Type your answer here, replacing this text._
not too much.  newborn either consider incur no charges (is this life insurance?)
or incur lots of medical charges, till they reach a age eg 5 and young adults when
they are healthy and incur few medical bills.
age 0 and 1 would not be smoker, right?  so this model probably invalid for young age.


\newpage

**16. [1 point] Add the line of best fit to your scatterplot by copying and pasting the plot's code from question 11 in the chunk below and adding a `geom` that can be used to add a regression line.**

```{r scatter-plot-with-line}
p16 <- NULL 
m = insure_model$coefficients[2] # slope  (it is a "named number" in R)
b = insure_model$coefficients[1] # intercept
#str(insure_model)
m
b
p16 = p11 + geom_abline(intercept=b,slope=m)
p16

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p16.R")
```

\newpage

**17. [2 points] What do you notice about the fit of the line in terms of the proportion of points above vs. below the line? Why do you think that is?**

_Type your answer here, replacing this text._
most points are below the lm() line, 
few are above, cuz there were a number of large outlier dragging up the average!

\newpage

**Run the following `filter()` function in the chunk below.**

```{r filter-smalller}
insure_smaller_subset <- insure_subset %>% 
  filter(charges < 30000 & ! (charges > 25000 & age == 20))

dim(insure_subset)[1] - dim(insure_smaller_subset)[1]

```

**18. [2 points] How many individuals were removed? Who were they?**

_Type your answer here, replacing this text._
dim(insure_subset)[1] - dim(insure_smaller_subset)[1]
3, they are the 3 outliers (has large charges, all age 20 per the code of the filter)

\newpage

**19. [2 points] Run a regression model on `insure_smaller_subset` between `charges` and `age`. Assign the model to `insure_better_model` and analyze the output using the `tidy()` function.**

```{r second-regression-mod}
insure_better_model <- NULL
insure_better_model = lm(charges ~ age, data=insure_smaller_subset)
tidy(insure_better_model)

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p19.R")
```

\newpage

**20. [2 points] Add the new regression line to your ggplot from question 16. Keep the original regression line on the plot for comparison. To distinguish the lines, change the color, line type, or line width of one of the lines.**

```{r scatter-two-lines}
p20 <- NULL # YOUR CODE HERE

linear_model2 = lm(charges ~ age, data=insure_smaller_subset)
new_m = linear_model2$coefficients[2] # slope  (it is a "named number" in R)
new_b = linear_model2$coefficients[1] # intercept
p20 = p16 + geom_abline(intercept=new_b,slope=new_m,lty=2,col="red")
p20
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p20.R")
```

\newpage

**21. [1 point] Calculate the r-squared value for `insure_model` and assign this value to `insure_model_r2`.**

```{r rsquared}
library(dplyr)
library(broom)
insure_model_r2 <- NULL
#XXinsure_model_r2 = insure_model %>% summarize( rrr2 =  cor(age,charges) )
insure_model_r2 = glance(insure_model) %>% pull(r.squared)
insure_model_r2   #++FIXME++

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p21.R")
```

**22. [1 point] Calculate the r-squared value for `insure_better_model` using a function learned in class. Assign this value to `insure_better_model_r2`.**

```{r rsquared2}
insure_better_model_r2 <- NULL 
### oh was i supposed to calculate by hand for above??
insure_better_model_r  = sqrt( glance(insure_better_model) %>% pull(r.squared) )
insure_better_model_r

insure_better_model_r2 =       glance(insure_better_model) %>% pull(r.squared) 

##insure_better_model_r2 = insure_better_model_r  ## NOPE.  grader wants the r.squared value, variable is named r2 anyway... 
insure_better_model_r2

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p22.R")
```

\newpage

**23. [2 points] Calculate the correlation coefficient between `age` and `charges` using `insure_subset`. Also calculate the squared correlation coefficient. You should use `summarize()` to create a dataframe of these two values and name the two variables `corr` and `corr_sq`, respectively. What do you notice about the relationship between the correlation coefficient and r-squared values that you calculated earlier?**

```{r correlations}
p23 <- NULL

#// lm( charges ~ age, data=insure_subset ) #

#// #%>%  = sqrt( glance(insure_better_model) %>% pull(r.squared) )

p23 = insure_subset %>% summarize( corr = cor(age,charges) , corr_sq = corr^2 )
#XX p23 = c( cor, cor^2 )


p23

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p23.R")
```

**24. [2 points] Calculate the correlation coefficient between `age` and `charges` using the smaller dataset `insure_smaller_subset`. Also calculate the squared correlation coefficient. You should use `summarize()` to create a dataframe of these two values and name the two variables `corr` and `corr_sq`, respectively. What do you notice about the relationship between the correlation coefficient and r-squared values that you calculated earlier?**

```{r correlations2}
p24 <- NULL
p24 = insure_smaller_subset %>% summarize( corr = cor(age,charges) , corr_sq = corr^2 )


##xx tmpp24 = insure_smaller_subset %>% cor(age,charges)

p24
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p24.R")
```

\newpage

**Your supervisor asks you to extend your analysis to consider other smokers with BMIs classified as overweight or obese. In particular, she wanted to know if the relationship between age and medical charges is different for different BMI groups. You can use data visualization coupled with your skills in linear regression to help answer this question.**

**25. [1 point] Make a new dataframe called `insure_smokers` that includes smokers of any BMI from the original `insure_data` dataset.**

```{r}
#insure_subset = insure_data %>% filter(smoker=="yes",bmi_cat=="Normal")
#insure_subset %>% dim
#dim( insure_data )

insure_smokers <- NULL
insure_smokers = insure_data %>% filter(smoker=="yes")

#dim(insure_smokers)

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p25.R")
```

\newpage

**26. [1 point] Make a scatterplot that examines the relationship between `age` and `charges` for normal, overweight, and obese individuals in three side by side plots. A `facet_` command may help you.**


~~~~
HW03 
p8 <- ggplot(data = CS_data, aes(x = CS_rate_100)) +
        geom_histogram(binwidth = 6, col = 'white', fill = 'sienna2') + 
        xlab('Cesarean delivery rate (%)') +
        theme_minimal() #+

p8 = p8 + facet_wrap(~Income_Group)


```{r ggplot-by-bmi}

## facet_wrap
library(ggplot2)
p26 <- NULL 
p26 = ggplot(data=insure_smokers, aes(x=age,y=charges)) + 
  geom_point() + theme_minimal()

p26 = p26 + facet_wrap(~bmi_cat)
p26
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p26.R")
```

**The plot above automatically displays the BMI categories alphabetically. Run the chunk below to assign a different order to the values of `bmi_cat`.**

```{r fct-relevel}
insure_smokers <- insure_smokers %>%
  mutate(bmi_cat_ordered = forcats::fct_relevel(bmi_cat, "Normal", "Overweight", "Obese"))
```

\newpage

**27. [1 point] Re-run your code from question 26, but facet using `bmi_cat_ordered`.**

```{r ggplot-by-bmi-2}
p27 <- NULL
p27

p27 = ggplot(data=insure_smokers, aes(x=age,y=charges)) +   geom_point() + theme_minimal()
p27 = p27 + facet_wrap(~bmi_cat_ordered)
p27
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p27.R")
```

\newpage

**28. [3 points] Run a separate linear model for each BMI group. To do this, you will need to subset your data into the three groups of interest. Call your models `normal_mod`, `overweight_mod`, `obese_mod`. Use the `tidy()` function to display the output from each model.**

```{r more-models-more-outputs}

## subset your data here

# '<<<<YOUR CODE HERE>>>>'
# '<<<<YOUR CODE HERE>>>>'
# '<<<<YOUR CODE HERE>>>>'

insure_smokers
#insure_data_normal = insure_data %>% filter(bmi_cat=="Normal") 
#insure_data_obese  = insure_data %>% filter(bmi_cat=="Obese") 
#insure_data_overweight  = insure_data %>% filter(bmi_cat=="Overweight") 
insure_data_normal = insure_smokers %>% filter(bmi_cat=="Normal") 
insure_data_obese  = insure_smokers %>% filter(bmi_cat=="Obese") 
insure_data_overweight  = insure_smokers %>% filter(bmi_cat=="Overweight") 



str(insure_data_normal)
str(insure_data_obese)
str(insure_data_overweight)

#View(insure_data_normal)
## generate your models

normal_mod <- '<<<<YOUR CODE HERE>>>>'
overweight_mod <- '<<<<YOUR CODE HERE>>>>'
obese_mod <- '<<<<YOUR CODE HERE>>>>'


normal_mod <- lm(charges ~ age, data=insure_data_normal)
obese_mod <- lm(charges ~ age, data=insure_data_obese)
overweight_mod <- lm(charges ~ age, data=insure_data_overweight)

obese_mod

## somehow they expect slightly different result than what my code found...
## why?
## was I supposed to remove outlier?  they didn't say that... 
## she wanted the smokers data only... insure_smokers
#XX normal_mod$coefficients[[2]] = 246.1376
#XXobese_mod$coefficients[[2]] = 281.1528

## tidy your models

# '<<<<YOUR CODE HERE>>>>'
# '<<<<YOUR CODE HERE>>>>'
# '<<<<YOUR CODE HERE>>>>'
tidy(normal_mod)
tidy(overweight_mod)
tidy(obese_mod)

normal_mod$coefficients[2]

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p28.R")
```

\newpage

**For the next three problems, use the models to predict medical charges for a 20-year old by weight category. You don't need an R function to make these predictions, just the output from the models. Show your work for each calculation.**

**29. [1 point] Predict the medical charges for a 20 year old with a normal BMI.**

```{r p29}

## likely want the y = a + bx thing
a = normal_mod$coefficients[[1]]  # intercept
b = normal_mod$coefficients[[2]]  # slope
x = 20
y = a + b*x
p29 <- NULL
p29  = y
p29
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p29.R")
```

**30. [1 point] Predict the medical charges for a 20 year old with an overweight BMI.**

```{r p30}

#aow = overweight_mod$coefficients[1]  # intercept  ## using this end up in a extra data structure layer that the grader don't accept
aow = overweight_mod$coefficients[[1]]  # intercept
bow = overweight_mod$coefficients[[2]]  # slope
xow = 20
yow = aow + bow*x

#overweight_mod$coefficients[3]

p30 <- NULL
p30 = yow
p30

# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p30.R")
```

**31. [1 point] Predict the medical charges for a 20 year old with an obese BMI.**

```{r p31}
p31 <- NULL
p31 
aob = obese_mod$coefficients[[1]]  # intercept
bob = obese_mod$coefficients[[2]]  # slope
xob = 20
yob = aob + bob*x

p31 = yob
p31
# YOUR CODE HERE
```

```{r}
. = ottr::check("tests/p31.R")
```
\newpage

**32. [3 points] In three sentences maximum, comment on (1) the direction of the association, (2) how much the slopes vary across the BMI groups, and (3) how much the predicted medical charges for a 20-year old varies by BMI category.**

_Type your answer here, replacing this text._


 (1) the direction of the association, 
   _monotonically increasing from normal to overweight to obese_
   
 (2) how much the slopes vary across the BMI groups, 
    _slope increases steadily from normal to overweight to obese, first by 1.16 times, then by 2.46 times_

 (3) how much the predicted medical charges for a 20-year old varies by BMI category.
   _charges increases from normal to overweight to obese_

```{r}
### aob = obese_mod$coefficients[[1]]  # intercept
c(aow/a, aob/aow)

c(a, aow, aob)
c(y, yow, yob)

```

## END

